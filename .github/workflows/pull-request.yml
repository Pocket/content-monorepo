# A set of jobs that should always run no matter what on all Pull Requests in this repo
name: Pull Request
on:
  pull_request:

jobs:
  check-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm & node
        uses: pocket/pocket-monorepo/.github/actions/install-pnpm-and-node@main

      - name: Check for mismatched dependencies
        run: pnpm run list-mismatches

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm & node
        uses: pocket/pocket-monorepo/.github/actions/install-pnpm-and-node@main

      - name: Lint code
        run: pnpm run lint

  unit-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm & node
        uses: pocket/pocket-monorepo/.github/actions/install-pnpm-and-node@main

      - name: Unit tests
        # Following uses a 2 concurrency because terraform modules seems to fail with an OOM error on CI if we do more.
        run: pnpm run test --concurrency=2

  test-integrations:
    runs-on: ubuntu-latest
    steps:
      - name: Dummy placeholder
        run: |
          echo "Ensuring 'testâ€‘integrations' status check is always present"
          echo "so branch protection rules can reliably require it."

  claude-review:
    name: Claude PR Review
    runs-on: ubuntu-latest

    # Only run for PRs from branches in this repo, not forks
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}

    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: "/review"
          # Pre-loads full PR context (description, diff, comments) into the prompt. Also shows a progress tracker.
          track_progress: true
          # Allow inline code comments, PR comments, and reading PR diffs/metadata (on top of default Read/Grep/Glob).
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
