services:
  # Start Common Services
  mysql:
    image: mysql:8.0
    ports:
      - '3306:3306'
    environment:
      - MYSQL_ALLOW_EMPTY_PASSWORD=yes
      - TZ=UTC

  localstack:
    image: localstack/localstack:3.1.0@sha256:9d278167f2b7fda866b8bbe2a077a3fcf2e2f704b024fa76211c7c468428f977
    ports:
      - '4566:4566'
    volumes:
      - ./.docker/aws:/etc/localstack/init/ready.d
    environment:
      SERVICES: s3,dynamodb
      DATA_DIR: /tmp/localstack/data
      DOCKER_HOST: unix:///var/run/docker.sock
      LOCALSTACK_HOST: localstack
    healthcheck:
      test:
        - CMD
        - bash
        - -c
        - curl --write-out '%{http_code}' --silent --output /dev/null http://localhost:4566/_localstack/health
      interval: 5s
      timeout: 10s
      start_period: 10s

  snowplow:
    image: pocket/snowplow-micro:dev
    healthcheck:
      test: ['CMD', 'bash', '-c', 'curl -sf localhost:9090/micro/all']
      interval: 5s
      timeout: 10s
      start_period: 10s
      retries: 30
    ports:
      - '9090:9090'

  # Note: This is not the collector we use in Prod (which is AWS X-Ray), but
  # works for local testing.
  #
  # To tail these logs (to see trace details), run:
  # docker compose logs -f otlpcollector
  #
  # You may want to change line 56 below from 'error' to 'debug' for more data.
  otlpcollector:
    image: otel/opentelemetry-collector-contrib
    command:
      [
        '--config',
        '/etc/otelcol-contrib/config.yaml',
        '--set=service.telemetry.logs.level=error',
      ]
    # If we want to set a custom config we would do it by mounting the file below.
    # volumes:
    #   - ./otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml
    ports:
      # there are lots more ports available, but these are the only one's
      # currently being used
      - 4317:4317 # OTLP gRPC receiver
      - 4318:4318 # OTLP http receiver
